# GitHub Actions 构建 Android APK (Buildozer)
name: Build Android APK

# 触发条件：推送到主分支、PR、手动触发
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 创建 Release 必须的权限

    steps:
      # 1. 检出代码（必须确保完整检出，缓存依赖此步骤）
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Python 环境（修复缓存路径问题）
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # 开启缓存，同时指定依赖文件在 android 目录下
          cache: 'pip'
          # 关键修复：指向 android 目录下的 requirements.txt（若为 pyproject.toml 则改为 android/pyproject.toml）
          cache-dependency-path: android/requirements.txt

      # 3. 安装系统级依赖
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            git \
            python3-pip \
            ffmpeg \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
            libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev \
            libgstreamer1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
            libffi-dev libssl-dev autoconf automake libtool pkg-config \
            libncurses5-dev libncursesw5-dev libtinfo5 \
            lib32z1 lib32stdc++6 \
            openjdk-17-jdk

      # 4. 安装 Buildozer 和 Cython（若有 requirements.txt，可改为 pip install -r android/requirements.txt）
      - name: Install Buildozer
        run: |
          python -m pip install --upgrade pip
          # 优先使用 android 目录下的依赖文件，无则手动安装
          if [ -f "android/requirements.txt" ]; then
            python -m pip install -r android/requirements.txt
          else
            python -m pip install buildozer cython==0.29.36
          fi

      # 5. 缓存 Buildozer 依赖 (加速构建，避免重复下载 SDK/NDK)
      - name: Cache Buildozer dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            android/.buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('android/buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      # 6. 构建 APK (核心步骤，包含重试机制)
      - name: Build APK with Retry
        working-directory: ./android
        run: |
          # 打印 Java 版本和路径，用于调试环境问题
          java -version
          echo "JAVA_HOME: $JAVA_HOME"
          
          # 重试逻辑：最多尝试 3 次，间隔 30 秒
          for ATTEMPT in 1 2 3; do
            echo "=== Starting build attempt $ATTEMPT ==="
            if buildozer -v android debug; then
              echo "=== Build succeeded on attempt $ATTEMPT! ==="
              exit 0
            fi
            echo "=== Attempt $ATTEMPT failed. Retrying in 30 seconds... ==="
            sleep 30
          done
          
          # 如果三次都失败，终止工作流
          echo "=== All 3 build attempts failed. ==="
          exit 1
        env:
          BUILDOZER_WARN_ON_ROOT: '0'
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

      # 7. 上传 APK 作为构建产物
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        if: always() # 即使构建失败，也尝试上传日志
        with:
          name: bambu-rfid-apk
          path: |
            android/bin/*.apk
            android/buildozer.spec
            android/.buildozer/logs/ # 新增：上传 Buildozer 日志，方便排查构建失败
          retention-days: 30

      # 8. 创建 GitHub Release (仅在推送 Tag 时执行)
      - name: Create GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: android/bin/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
